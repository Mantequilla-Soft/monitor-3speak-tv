import { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Paper,
  Tabs,
  Tab,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  LinearProgress,
  Alert,
  CircularProgress,
  TablePagination,
  IconButton,
  InputBase,
  Grid,
} from '@mui/material';
import {
  CheckCircle,
  Warning,
  HourglassEmpty,
  Search as SearchIcon,
  Refresh as RefreshIcon,
  Speed as SpeedIcon,
  Computer as ComputerIcon,
  ContentCopy as CopyIcon,
} from '@mui/icons-material';
import { SegmentedControl, CompactMetricCard } from '../components';

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`jobs-tabpanel-${index}`}
      aria-labelledby={`jobs-tab-${index}`}
      {...other}
    >
      {value === index && <Box sx={{ pt: 3 }}>{children}</Box>}
    </div>
  );
}

interface Job {
  id: string;
  _id?: string;
  created_at: string;
  status: string;
  metadata?: {
    video_owner: string;
    video_permlink: string;
  };
  owner?: string;
  permlink?: string;
  input?: {
    size: number;
  };
  input_size?: number;
  assigned_to?: string;
  assigned_date?: string;
  completed_at?: string;
  progress?: {
    pct: number;
  };
  result?: {
    message?: string;
  };
  totalDuration?: number;
  encodingDuration?: number;
  encoderInfo?: {
    nodeName: string;
    hiveAccount?: string;
    didKey: string;
  };
}

export function Jobs() {
  const [tabValue, setTabValue] = useState(0);
  const [availableJobs, setAvailableJobs] = useState<Job[]>([]);
  const [activeJobs, setActiveJobs] = useState<Job[]>([]);
  const [completedJobs, setCompletedJobs] = useState<Job[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Pagination states for each tab
  const [availablePage, setAvailablePage] = useState(0);
  const [availableRowsPerPage, setAvailableRowsPerPage] = useState(10);
  const [activePage, setActivePage] = useState(0);
  const [activeRowsPerPage, setActiveRowsPerPage] = useState(10);
  const [completedPage, setCompletedPage] = useState(0);
  const [completedRowsPerPage, setCompletedRowsPerPage] = useState(10);

  const handleTabChange = (_event: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  // Available Jobs Pagination
  const handleAvailablePageChange = (_event: unknown, newPage: number) => {
    setAvailablePage(newPage);
  };

  const handleAvailableRowsPerPageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setAvailableRowsPerPage(parseInt(event.target.value, 10));
    setAvailablePage(0);
  };

  const paginatedAvailableJobs = availableJobs.slice(
    availablePage * availableRowsPerPage,
    availablePage * availableRowsPerPage + availableRowsPerPage
  );

  // Active Jobs Pagination
  const handleActivePageChange = (_event: unknown, newPage: number) => {
    setActivePage(newPage);
  };

  const handleActiveRowsPerPageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setActiveRowsPerPage(parseInt(event.target.value, 10));
    setActivePage(0);
  };

  const paginatedActiveJobs = activeJobs.slice(
    activePage * activeRowsPerPage,
    activePage * activeRowsPerPage + activeRowsPerPage
  );

  // Completed Jobs Pagination
  const handleCompletedPageChange = (_event: unknown, newPage: number) => {
    setCompletedPage(newPage);
  };

  const handleCompletedRowsPerPageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setCompletedRowsPerPage(parseInt(event.target.value, 10));
    setCompletedPage(0);
  };

  const paginatedCompletedJobs = completedJobs.slice(
    completedPage * completedRowsPerPage,
    completedPage * completedRowsPerPage + completedRowsPerPage
  );

  // Format file size
  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  // Format relative time
  const formatRelativeTime = (date: string): string => {
    const now = new Date();
    const then = new Date(date);
    const diffMs = now.getTime() - then.getTime();
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
  };

  // Format duration in seconds to readable string
  const formatDuration = (seconds: number): string => {
    if (seconds < 60) return `${seconds}s`;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins < 60) return `${mins}m ${secs}s`;
    const hours = Math.floor(mins / 60);
    const remainMins = mins % 60;
    return `${hours}h ${remainMins}m`;
  };

  // Fetch jobs data
  const fetchJobs = async () => {
    try {
      setLoading(true);
      setError(null);

      const endpoints = [
        '/api/jobs/available',
        '/api/jobs/active',
        '/api/jobs/completed?limit=100'
      ];

      const responses = await Promise.all(
        endpoints.map(endpoint => fetch(endpoint))
      );

      const data = await Promise.all(
        responses.map(response => response.json())
      );

      if (data[0].success) setAvailableJobs(data[0].data || []);
      if (data[1].success) setActiveJobs(data[1].data || []);
      if (data[2].success) setCompletedJobs(data[2].data || []);

    } catch (error) {
      console.error('Error fetching jobs:', error);
      setError('Failed to fetch jobs data');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchJobs();

    // Auto-refresh based on active tab
    const intervals: NodeJS.Timeout[] = [];
    
    if (tabValue === 0) {
      // Available jobs - refresh every 10 seconds
      const interval = setInterval(fetchJobs, 10000);
      intervals.push(interval);
    } else if (tabValue === 1) {
      // Active jobs - refresh every 5 seconds
      const interval = setInterval(fetchJobs, 5000);
      intervals.push(interval);
    }

    return () => intervals.forEach(interval => clearInterval(interval));
  }, [tabValue]);

  if (loading && availableJobs.length === 0 && activeJobs.length === 0 && completedJobs.length === 0) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box>
      <Typography variant="h4" gutterBottom>
        Job Management
      </Typography>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }}>
          {error}
        </Alert>
      )}

      <Paper sx={{ width: '100%' }}>
        <Tabs value={tabValue} onChange={handleTabChange} aria-label="job tabs">
          <Tab 
            label={`Available (${availableJobs.length})`} 
            icon={<HourglassEmpty />} 
            iconPosition="start"
          />
          <Tab 
            label={`In Progress (${activeJobs.length})`} 
            icon={<CircularProgress size={20} />} 
            iconPosition="start"
          />
          <Tab 
            label={`Completed (${completedJobs.length})`} 
            icon={<CheckCircle />} 
            iconPosition="start"
          />
        </Tabs>

        {/* Available Jobs Tab */}
        <TabPanel value={tabValue} index={0}>
          {availableJobs.length === 0 ? (
            <Box sx={{ textAlign: 'center', py: 4 }}>
              <CheckCircle sx={{ fontSize: 60, color: 'success.main', mb: 2 }} />
              <Typography variant="h6" color="text.secondary">
                No jobs waiting - all clear!
              </Typography>
            </Box>
          ) : (
            <Box>
              <TableContainer sx={{ overflowX: 'auto' }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>Job ID</TableCell>
                      <TableCell>Video</TableCell>
                      <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>Size</TableCell>
                      <TableCell>Waiting</TableCell>
                      <TableCell>Status</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {paginatedAvailableJobs.map((job) => {
                    const age = new Date().getTime() - new Date(job.created_at).getTime();
                    const isOld = age > 20 * 60 * 1000; // 20 minutes
                    
                    return (
                      <TableRow 
                        key={job.id}
                        sx={{ backgroundColor: isOld ? 'warning.light' : 'inherit' }}
                      >
                        <TableCell sx={{ fontFamily: 'monospace', fontSize: '0.75rem', display: { xs: 'none', sm: 'table-cell' } }}>
                          {job.id.substring(0, 8)}...
                        </TableCell>
                        <TableCell sx={{ fontSize: { xs: '0.75rem', sm: '0.875rem' } }}>
                          {job.metadata?.video_owner || job.owner}/{job.metadata?.video_permlink || job.permlink}
                        </TableCell>
                        <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>{formatFileSize(job.input?.size || job.input_size || 0)}</TableCell>
                        <TableCell>{formatRelativeTime(job.created_at)}</TableCell>
                        <TableCell>
                          {isOld && (
                            <Chip 
                              icon={<Warning />} 
                              label="Stuck" 
                              size="small" 
                              color="warning"
                            />
                          )}
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </TableContainer>
            <TablePagination
              component="div"
              count={availableJobs.length}
              page={availablePage}
              onPageChange={handleAvailablePageChange}
              rowsPerPage={availableRowsPerPage}
              onRowsPerPageChange={handleAvailableRowsPerPageChange}
              rowsPerPageOptions={[10, 25, 50]}
              sx={{
                borderTop: '1px solid rgba(76, 85, 242, 0.1)',
                '.MuiTablePagination-toolbar': {
                  color: 'text.secondary',
                },
                '.MuiTablePagination-selectLabel, .MuiTablePagination-displayedRows': {
                  fontSize: '0.875rem',
                },
              }}
            />
          </Box>
          )}
        </TabPanel>

        {/* In Progress Tab */}
        <TabPanel value={tabValue} index={1}>
          {activeJobs.length === 0 ? (
            <Box sx={{ textAlign: 'center', py: 4 }}>
              <Typography variant="h6" color="text.secondary">
                No active jobs
              </Typography>
            </Box>
          ) : (
            <Box>
              <TableContainer sx={{ overflowX: 'auto' }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>Job ID</TableCell>
                      <TableCell>Video</TableCell>
                      <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>Encoder</TableCell>
                      <TableCell sx={{ width: { xs: '30%', sm: '20%' } }}>Progress</TableCell>
                      <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>Elapsed</TableCell>
                      <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>Size</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {paginatedActiveJobs.map((job) => (
                    <TableRow key={job.id}>
                      <TableCell sx={{ fontFamily: 'monospace', fontSize: '0.75rem', display: { xs: 'none', sm: 'table-cell' } }}>
                        {job.id.substring(0, 8)}...
                      </TableCell>
                      <TableCell sx={{ fontSize: { xs: '0.75rem', sm: '0.875rem' } }}>
                        {job.metadata?.video_owner || job.owner}/{job.metadata?.video_permlink || job.permlink}
                      </TableCell>
                      <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>
                        <Typography variant="caption">
                          {job.encoderInfo?.nodeName || (job.assigned_to ? job.assigned_to.substring(0, 20) + '...' : 'N/A')}
                        </Typography>
                      </TableCell>
                      <TableCell>
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                          <LinearProgress 
                            variant="determinate" 
                            value={job.progress?.pct || 0} 
                            sx={{ flexGrow: 1 }}
                          />
                          <Typography variant="caption">
                            {job.progress?.pct || 0}%
                          </Typography>
                        </Box>
                      </TableCell>
                      <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>
                        {job.assigned_date ? formatRelativeTime(job.assigned_date) : 'N/A'}
                      </TableCell>
                      <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>{formatFileSize(job.input?.size || job.input_size || 0)}</TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>
            <TablePagination
              component="div"
              count={activeJobs.length}
              page={activePage}
              onPageChange={handleActivePageChange}
              rowsPerPage={activeRowsPerPage}
              onRowsPerPageChange={handleActiveRowsPerPageChange}
              rowsPerPageOptions={[10, 25, 50]}
              sx={{
                borderTop: '1px solid rgba(76, 85, 242, 0.1)',
                '.MuiTablePagination-toolbar': {
                  color: 'text.secondary',
                },
                '.MuiTablePagination-selectLabel, .MuiTablePagination-displayedRows': {
                  fontSize: '0.875rem',
                },
              }}
            />
          </Box>
          )}
        </TabPanel>

        {/* Completed Jobs Tab */}
        <TabPanel value={tabValue} index={2}>
          {completedJobs.length === 0 ? (
            <Box sx={{ textAlign: 'center', py: 4 }}>
              <Typography variant="h6" color="text.secondary">
                No completed jobs yet
              </Typography>
            </Box>
          ) : (
            <Box>
              <TableContainer sx={{ overflowX: 'auto' }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>Job ID</TableCell>
                      <TableCell>Video</TableCell>
                      <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>Encoder</TableCell>
                      <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>Completed</TableCell>
                      <TableCell>Total Duration</TableCell>
                      <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>Encoding Time</TableCell>
                      <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>Size</TableCell>
                      <TableCell>Status</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {paginatedCompletedJobs.map((job) => {
                    const isForced = job.result?.message?.includes('Force processed');
                    const totalDur = job.totalDuration || 0;
                    const durColor = totalDur < 300 ? 'success' : totalDur < 1800 ? 'warning' : 'error';
                    
                    return (
                      <TableRow key={job.id}>
                        <TableCell sx={{ fontFamily: 'monospace', fontSize: '0.75rem', display: { xs: 'none', md: 'table-cell' } }}>
                          {job.id.substring(0, 8)}...
                        </TableCell>
                        <TableCell sx={{ fontSize: { xs: '0.75rem', sm: '0.875rem' } }}>
                          {job.metadata?.video_owner || job.owner}/{job.metadata?.video_permlink || job.permlink}
                        </TableCell>
                        <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>
                          <Typography variant="caption">
                            {job.encoderInfo?.nodeName || (job.assigned_to ? job.assigned_to.substring(0, 20) + '...' : 'N/A')}
                          </Typography>
                        </TableCell>
                        <TableCell sx={{ display: { xs: 'none', sm: 'table-cell' } }}>
                          {job.completed_at ? formatRelativeTime(job.completed_at) : 'N/A'}
                        </TableCell>
                        <TableCell>
                          <Chip 
                            label={formatDuration(totalDur)} 
                            size="small" 
                            color={durColor}
                          />
                        </TableCell>
                        <TableCell sx={{ display: { xs: 'none', md: 'table-cell' } }}>
                          {job.encodingDuration ? formatDuration(job.encodingDuration) : 'N/A'}
                        </TableCell>
                        <TableCell sx={{ display: { xs: 'none', lg: 'table-cell' } }}>{formatFileSize(job.input?.size || job.input_size || 0)}</TableCell>
                        <TableCell>
                          <Chip 
                            label={isForced ? 'Forced' : 'Success'} 
                            size="small" 
                            color={isForced ? 'warning' : 'success'}
                          />
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </TableContainer>
            <TablePagination
              component="div"
              count={completedJobs.length}
              page={completedPage}
              onPageChange={handleCompletedPageChange}
              rowsPerPage={completedRowsPerPage}
              onRowsPerPageChange={handleCompletedRowsPerPageChange}
              rowsPerPageOptions={[10, 25, 50, 100]}
              sx={{
                borderTop: '1px solid rgba(76, 85, 242, 0.1)',
                '.MuiTablePagination-toolbar': {
                  color: 'text.secondary',
                },
                '.MuiTablePagination-selectLabel, .MuiTablePagination-displayedRows': {
                  fontSize: '0.875rem',
                },
              }}
            />
          </Box>
          )}
        </TabPanel>
      </Paper>
    </Box>
  );
}
